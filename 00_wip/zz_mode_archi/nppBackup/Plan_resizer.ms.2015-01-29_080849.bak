/*
HOW TO:
numeric resize
1. "create scaler to create" or init scaler object
2. "create size reference" to create or init size reference object
3. "parent map" to init map to resize
4. place resizer
5. "resize" to resize map
tz
maj:
-- add init scaler and resizer on opening rollout
-- add deletion system
-- add root and target system selection
-- enable numeric calculation
*/


--  create system
fn createScalerSys =
(
	local startPt, endPt, scaler

	startPt = getnodebyname  "startPoint"
	if  startPt == undefined do startPt = point name: "startPoint" wirecolor: red size: 20 box: true cross: false

	endPt = getnodebyname  "endPoint"
	if  endPt == undefined do endPt = point name: "endPoint" wirecolor: red parent: startPt size: 15 box: false cross: true pos: [10,0,0]
		
	scaler = getnodebyname  "scaler"
	if  scaler == undefined do scaler = point name: "scaler" wirecolor: yellow parent: startPt size: 15 box: true cross: true
		
	return #(startPt, endPt, scaler)
)



fn createRefSys =
(
	local startSize, endSize
	
	startSize = getnodebyname  "startSize"
	if  startSize == undefined do startSize = point name: "startSize" wirecolor: green size: 15 box: true cross: true

	endSize = getnodebyname  "endSize"
	if  endSize == undefined do endSize = point name: "endSize" wirecolor: green parent: startSize size: 15 box: false cross: true pos: [10,0,0]
		
	return #(startSize, endSize)
)


rollout planResizerRLT "blueprint resizer" width: 250
(
-- 	vars
	local scalerArray = #()
	local refArray = #()
	local reelDist
	
	local scalerParent
	local resizerParent
	
	local	startPt 
	local	endPt 
	local	scaler 
	
	local	startSize
	local	endSize 

-- 	fonctions
-- 	UI

	-- pick blueprint resizer
			-- create resizer
	group "Scaler:"
	(
		button createScaler_bt "create scaler" across:2
		button selScaler_bt "select scaler"

		button parentScaler_bt "parent map" across:2
		button centerScaler_bt "center map" 
		
		button resetScaler "Reset Scaler"
		
		spinner multiScaler "Scaler size x" range: [0,100,1] type:#float across:2
		button resizeScaler "resize"

		edittext mapToResize_et "map to resize:" readOnly: true
		edittext distResize_et "distance:" readOnly: true
				
		button refreshDistResize_pb "refresh distance"
	)
	
	group "Reference:"
	(

		-- reference selection (radio button)
		radiobuttons sizeRef_rb labels:#("numeric", "visual")
	)
			-- numeric
			-- repere
		--  enter precious size
	
	group "visual reference:"
	(
		button createSizeRef_bt "create size reference" across: 2
		button selSize_bt "select size reference"
		
		button parentRef_bt "parent map" across:2
		button centerRef_bt "center map" 
		
		button resetResizer "Reset Resizer"
		
		spinner multiResizer "Resizer size x" range: [0,100,1] type:#float across:2
		button resizeResizer "resize"
		
		edittext mapAsRef_et "map as ref:" readOnly: true
		edittext distRef_et "distance:" readOnly: true
		
		button refreshDistRef_pb "refresh distance"
			
	)
	
	group "Numeric:"
	(
		spinner size_sp "size:" range: [0,100000,0]  type: #worldunits 
		-- display size reference	
	)
	
	
	-- rescale points
	button rescale_bt "resize map"

-- 	actions
	
	on createScaler_bt pressed do
	(
		scalerArray = createScalerSys()
		startPt = scalerArray[1]
		endPt = scalerArray[2]
		scaler = scalerArray[3]
		print scalerArray
	)

	on selScaler_bt pressed do
	(
		select scalerArray
	)
	
	on refreshDistResize_pb pressed do
	(
		reelDist = distance startPt endPt
		distResize_et.text = reelDist as string
	)
	
	on parentScaler_bt pressed do
	(
		sel = $selection
		if sel.count == 1 then
		(
			for s in sel do
			(
				scalerParent = s
				startPt.parent = s
				mapToResize_et.text = s.name
				
			)
		)
		else
		(
			print "bad selection"
		)
	)
	
	on centerScaler_bt pressed do
	(
		map = getnodebyname mapToResize_et.text
		if map != undefined then
		(	
			startPt.rotation = map.rotation
			startPt.pos = map.pivot
		)
		else
		(
			print "no map selected"
		)
		
	)
	
	on resizeScaler pressed do
	(
		startPt.size = startPt.size*multiScaler.value
		endPt.size = endPt.size*multiScaler.value
		scaler.size = scaler.size*multiScaler.value
		multiScaler.value = 1.0 
	)
	
-- 	
-- 	-- resize with a dimension, resize with a size reference.

-- 	-- create visual resizer
	on createSizeRef_bt pressed do
	(
		refArray = createRefSys()
		startSize = refArray[1]
		endSize = refArray[2]
		print refArray
	)
	
	on selSize_bt pressed do
	(
		select refArray
	)
	
	on refreshDistRef_pb pressed do
	(
		refDist = distance startSize endSize
		print refDist
		distRef_et.text =  refDist as string
	)
	
	on parentRef_bt pressed do
	(
		sel = $selection
		if sel.count == 1 then
		(
			for s in sel do
			(
				refParent = s
				startSize.parent = s
				mapAsRef_et.text = s.name
				
			)
		)
		else
		(
			print "bad selection"
		)
	)

	
	on centerRef_bt pressed do
	(
		print mapAsRef_et.text
		mapRef = getnodebyname mapAsRef_et.text
		print mapRef
		if mapRef != undefined then
		(	
			startSize.rotation = mapRef.rotation
			startSize.pos = mapRef.pivot
		)
		else
		(
			print "no map selected"
		)
		
	)
	
		
	on resizeResizer pressed do
	(
		startSize.size = startSize.size*multiResizer.value
		endSize.size = endSize.size*multiResizer.value
		multiResizer.value = 1.0 
	)
	

	
-- 	-- resize!
	on rescale_bt pressed do
	(
		local aimedDist
		
		if sizeRef_rb.state == 1 then
		(
			print "numeric reference"
			aimedDist = size_sp.value
		)
		else if sizeRef_rb.state == 2 then
		(
			print "visual reference"
			-- reelDist = float( distance startPt endPt)
			aimedDist =  float(distance startSize endSize)
			-- ratio = aimedDist/reelDist

			-- startPt.parent = undefined
			-- scalerParent.parent = scaler
			-- scaler.scale = scaler.scale*ratio
			-- scalerParent.parent = undefined
			
			-- scaler.scale = [1,1,1]
			-- startPt.parent = scalerParent
		)
		else
		(
			print "fail"
		)
		print aimedDist
		reelDist = float( distance startPt endPt)
		-- aimedDist =  float(distance startSize endSize)
		ratio = aimedDist/reelDist

		startPt.parent = undefined
		scalerParent.parent = scaler
		scaler.scale = scaler.scale*ratio
		scalerParent.parent = undefined
		
		scaler.scale = [1,1,1]
		startPt.parent = scalerParent
	)
	
)

theNewFloater = newRolloutFloater "Blueprint Tools" 300 500
addRollout planResizerRLT theNewFloater

createdialog planResizerRLT style: #(#style_resizing,#style_titlebar, #style_border, #style_sysmenu,#style_minimizebox, #style_maximizebox )






